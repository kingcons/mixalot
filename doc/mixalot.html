<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">

<html>
<head>
  <title>Mixalot User Manual</title>
  <style type="text/css" title="currentStyle" media="screen">
    @import "style.css";
  </style>
</head>

<body>

<h1>Mixalot User Manual</h1>
<p>Version 0.0.3</p>

<!-- Contents -->

<h2>Table of Contents</h2>

<ol>
  <li><a href="#Introduction">Introduction</a></li>
  <li><a href="#Installation">Installation</a></li>
  <li><a href="#Portability">Portability</a></li>

  <li><a href="#mixalot">System: mixalot</a>
    <ul>
      <li><a href="#mix_Introduction">Introduction</a></li>

      <li><a href="#mix_Mixers">Mixers</a>
      </li>

      <li><a href="#mix_Streamers">Streamers</a>
        <ul>
          <li><a href="#mix_BasicStreamerProtocol">Basic Streamer Protocol</a></li>
          <li><a href="#mix_PausingProtocol">Pausing Protocol</a></li>
          <li><a href="#mix_SeekableProtocol">Seekable Protocol</a></li>
        </ul>
      </li>

      <li><a href="#mix_SampleManipulation">Sample Manipulation</a>

      </li>
    </ul>
  </li>

  <li><a href="#mpg123-ffi">System: mpg123-ffi</a></li>
  <li><a href="#mixalot-mp3">System: mixalot-mp3</a></li>
  <li><a href="#vorbisfile-ffi">System: vorbisfile-ffi</a></li>
  <li><a href="#mixalot-vorbis">System: mixalot-vorbis</a></li>
  <li><a href="#flac-ffi">System: flac-ffi</a></li>
  <li><a href="#mixalot-flac">System: mixalot-flac</a></li>
  <li><a href="#future-work">Future Work</a></li>
  <li><a href="#License">License</a></li>
</ol>

<!-- Body Text -->

<!--  ----------------------------------------------------------------- -->
<h2><a name="Introduction"></a>Introduction</h2>

<p>Mixalot is a grab bag of systems related to audio in Common Lisp
under an MIT-style license. Currently it consists of a mixer component
providing straightforward audio output on Linux (via ALSA) and other platforms
(using <a href="http://xiph.org/ao/">libao</a>),
a <a href="http://common-lisp.net/project/cffi/">CFFI</a> binding to
the libmpg123 library, and a helper component allowing playback of MP3
files through the mixer.</p>

<!--  ----------------------------------------------------------------- -->
<h2><a name="Installation"></a>Installation</h2>

<p>The most recent development version of Mixalot is hosted on <a href="http://github.com/ahefner/mixalot">github</a> and can be obtained as follows:</p>
<pre class="lisp">
git clone git://github.com/ahefner/mixalot.git</pre>
The latest stable release is 0.0.2a and can be downloaded from <a href="http://vintage-digital.com/hefner/software/mixalot/mixalot-0.0.2a.tar.gz">http://vintage-digital.com/hefner/software/mixalot/mixalot-0.0.2a.tar.gz</a>. </p>

<p>Mixalot includes several ASDF systems which should be symlinked into the ASDF central registry in the usual fashion. It depends directly on the following systems:</p>
<ul>
  <li>CFFI</li>
  <li>bordeaux-threads</li>
  <li>Alexandria</li>
</ul>

<p>You may find this library useful for the following purposes:</p>
<ul>
  <li>Audio output, if you aren't overly concerned with latency</li>
  <li>Decoding an mp3 file to a vector in memory</li>
  <li>Playing an mp3 file</li>
  <li>Querying id3 tags</li>
</ul>


<!--  ----------------------------------------------------------------- -->
<h2><a name="Portability"></a>Portability</h2>

<p>The CFFI and bordeaux-threads libraries are used to ease porting
between lisp implementations. The mixer component of Mixalot chooses
at compile time to use ALSA (on Linux)
or <a href="http://xiph.org/ao/">libao</a> (everywhere else) and
should be able to produce audio on any platform supported by libao. In
order to be useful in an application, the mixer must also run in its
own (native) thread.
Therefore, the <tt>mixalot</tt> and <tt>mixalot-mp3</tt> systems should be usable on CL implementations capable of running multiple threads, on Linux or platforms supported by libao. It has been tested and is known to work in the following configurations:</p>
<ul>
  <li>SBCL (w/sb-thread enabled) on Linux/x86 and Linux/x86-64</li>
  <li>SBCL (w/sb-thread enabled) on Mac OS X 10.6.3 (x86_64)</li>
  <li>Clozure CL on Linux/x86_64</li>
</ul>
It has been tested on the following platforms and found not to work:
<ul>
  <li>ECL on Linux x86_64 (stuttering audio - performance issue?)</li>
</ul>

<p>The <tt>mpg123-ffi</tt> system is independent and should be usable on any CL supported by CFFI.</p>

<!--  ----------------------------------------------------------------- -->
<h2><a name="mixalot"></a>System: mixalot</h2>

<h3><a name="mix_Introduction"></a>Introduction</h3>

<p>Mixalot implements an audio mixer which handles the mixing of multiple
audio streams and playback through ALSA. Once created, a mixer runs in
its own thread of execution, and other threads can add and remove
audio streamers at any time. The terms "stream" and "streamer" are
used interchangeably here, but the concrete objects in the lisp system
are labelled "streamers" to avoid confusion with the Common Lisp
stream classes.</p>

<p>All functions in this section reside in the <tt>mixalot</tt> package.</p>

<h3><a name="mix_Mixers"></a>Mixers</h3>

<p>A mixer is host to zero or more streamers. In the <tt>mixalot</tt>
package, there are functions to create/destroy mixers, and add/remove
streamers from a mixer.</p>


<div class="def"><a name='main-thread-init'>Function</a>
                       <b>main-thread-init</b>
 <div class="docbody">
   <p>Initialize the platform's audio subsystem. This must be called
   from the main thread of the application. Under SBCL, this will be
   the thread containing the initial REPL, or the *inferior-lisp*
   buffer while using SLIME (TODO: investigate situation on Clozure
   CL). It is only necessary to call this once, and must be done
   before calling <a href="#create-mixer"><tt>create-mixer</tt></a>
   (which can be called from any thread).</p>

   <p>On Linux, Mixalot uses ALSA, which requires no such
   initialization. For consistency, this function is defined to do
   nothing, and calling it is unnecessary. On other platforms, which
   use libao for audio output, this initialization is mandatory due
   to arbitrary restrictions imposed by certain operating systems
   (notably Mac OS X).</p>
 </div>
</div>

<div class="def"><a name='create-mixer'>Function</a>
                       <b>create-mixer</b>
 <i><tt>&amp;key</tt> (rate 44100)</i> &rArr;
 <i>mixer</i>
 <div class="docbody">
   <p>Creates a mixer running at the specified sampling <i>rate</i>,
   and returns it. The default ALSA device is opened and a thread for
   the mixer is started. The chosen sample <i>rate</i> should match
   the sampling rate of the data you intend to play through the mixer -
   the Mixalot mixer does not perform resampling.</p>
 </div>
</div>

<div class="def"><a name='destroy-mixer'>Function</a>
                       <b>destroy-mixer</b>
 <i>mixer</i>
 <div class="docbody">
   <p>Requests that <i>mixer</i> be shut down. This will occur after
   the current audio buffer has completed playback. When the mixer
   shuts down, each of its streams will be removed just as
   if <a href="#mixer-remove-streamer"><tt>mixer-remove-streamer</tt></a>
   had been called, so it is not necessary to manually clean up the
   streams when shutting down a mixer. Attempts to add additional
   streamers to <i>mixer</i> after calling <tt>destroy-mixer</tt> on
   it will result in an error.</p>
 </div>
</div>

<div class="def"><a name='mixer-add-streamer'>Function</a>
                       <b>mixer-add-streamer</b>
 <i>mixer streamer</i> &rArr;
 <i>streamer start-time</i>
 <div class="docbody">
   <p>Add a <i>streamer</i> for playback by the
   given <i>mixer</i>. After being added to the <i>mixer</i>, it will
   begin calling the streamer functions
   (see <a href="#mix_BasicStreamerProtocol">Basic Streamer
   Protocol</a>) to generate samples.</p>
   <p>Returns two values: the <i>streamer</i> itself, and the time in
   samples since the start of the <i>mixer</i> when
   the <i>streamer</i> will begin playback.</p>
 </div>
</div>

<div class="def"><a name='mixer-remove-streamer'>Function</a>
                       <b>mixer-remove-streamer</b>
 <i>mixer streamer</i>
 <div class="docbody">
   <p>Request that <i>streamer</i> be from the <i>mixer</i>.
   The <a href="#streamer-cleanup"><tt>streamer-cleanup</tt></a>
   function will be called from within the mixer's thread when this
   occurs. This occurs asynchronously because the stream may be
   generating audio at the time this function is called, and it would
   not be safe to clean it up until it is assured that the mixer will
   not call the mix/write functions again.</p>
 </div>
</div>

<div class="def"><a name='mixer-remove-all-streamers'>Function</a>
                       <b>mixer-remove-all-streamers</b>
 <i>mixer</i>
 <div class="docbody">
   <p>Removes all streamers belonging to the <i>mixer</i>.</p>
 </div>
</div>

<div class="def"><a name="mixer-current-time">Function</a>
                       <b>mixer-current-time</b>
 <i>mixer</i> &rArr; <i>time</i>
 <div class="docbody">
   <p>Returns the <i>time</i>, measured in samples, since the mixer was created.</p>
 </div>
</div>

<div class="def"><a name="mixer-rate">Function</a>
                       <b>mixer-rate</b>
 <i>mixer</i> &rArr; <i>rate</i>
 <div class="docbody">
   <p>Returns the sampling <i>rate</i> in Hertz of the output and inputs to the mixer. </p>
 </div>
</div>

<h3><a name="mix_Streamers"></a>Streamers</h3>

<p>A streamer is any object serving as a source of samples which are mixed into the mixer's audio
buffer by implementing the <a href="#mix_BasicStreamerProtocol">Basic Streamer Protocol</a>.
  From the mixer thread, the
functions <a href="#streamer-mix-into"><tt>streamer-mix-into</tt></a>
and <a href="#streamer-write-into"><tt>streamer-write-into</tt></a>
are called periodically to generate audio. These two functions correspond to the cases of multiple or a single streamer being mixed, respectively, and it is only necessary to implement <a href="#streamer-mix-into"><tt>streamer-mix-into</tt></a>.</p>

<p>Defining a method on <a href="#streamer-write-into"><tt>streamer-write-into</tt></a> allows an optimization in the case where only one stream is being mixed into the buffer, where the streamer can (and is expected to) overwrite the specified range of the buffer rather than mixing with the existing audio. The default method on <a href="#streamer-write-into"><tt>streamer-write-into</tt></a> simply fills the specified range of the buffer to zero before calling <a href="#streamer-mix-into"><tt>streamer-mix-into</tt></a>.

<p>In many situations, a stream has only finite duration. In this situation, when the stream has reached its end, it can call <a href="#mixer-remove-streamer"><tt>mixer-remove-streamer</tt></a> from its write/mix method to remove itself from the mixer. This guarantees its mix/write methods will not be called again, and the mixer will call <a href="#streamer-cleanup"><tt>streamer-cleanup</tt></a> to ensure any resources associated with the streamer are released.</p>

<p>The simplest example of a streamer is a function object taking the arguments of <a href="#streamer-mix-into"><tt>streamer-mix-into</tt></a>. This is enabled by pre-existing methods on the streamer functions. Here is an example of a streamer implemented as a lambda function which produces a series of six tones with increasing frequency, then removes itself from the mixer:</p> <pre class="lisp">
(defun make-test-streamer ()
  (let ((n 0)
        (phase 0.0))
    (lambda (streamer mixer buffer offset length time)
      (declare (ignore time))
      (loop for index upfrom offset
            repeat length
            with freq = (+ 200 (* n 200))
            with dp = (* 2.0 pi freq 1/44100)
            as sample = (round (* 5000 (sin phase)))
            do
            (mixalot:stereo-incf (aref buffer index) (mixalot:mono->stereo sample))
            (incf phase dp))
      (incf n)
      (when (= n 6)
        (mixalot:mixer-remove-streamer mixer streamer)))))
</pre>

<p>Here is an example of how to create a mixer and play the test streamer defined above:</p>

<pre class="lisp">
CL-USER> (defparameter *mixer* (mixalot:create-mixer))
*MIXER*
CL-USER> (mixer-add-streamer *mixer* (make-test-streamer))
#&lt;CLOSURE (LAMBDA (STREAMER MIXER BUFFER ...)) {1003F045A9}&gt;
507904
CL-USER>
</pre>

<p>Here is the same streamer, implemented via classes and methods:</p>

<pre class="lisp">
(defclass test-streamer ()
  ((n     :initform 0)
   (phase :initform 0.0)))

(defmethod mixalot:streamer-mix-into ((streamer test-streamer) mixer buffer offset length time)
  (declare (ignore time))
  (with-slots (n phase) streamer
    (loop for index upfrom offset
          repeat length
          with freq = (+ 200 (* n 200))
          with dp = (* 2.0 pi freq 1/44100)
          as sample = (round (* 5000 (sin phase)))
          do
          (mixalot:stereo-incf (aref buffer index) (mixalot:mono->stereo sample))
          (incf phase dp))
    (when (= (incf n) 6)
      (mixalot:mixer-remove-streamer mixer streamer))))
</pre>

<h4><a name="mix_BasicStreamerProtocol"></a>Basic Streamer Protocol</h4>

<p>These generic functions define the essential behaviors of an audio streamer. Of them, only <a href="#streamer-mix-into"><tt>streamer-mix-into</tt></a> is mandatory to implement.</p>

<div class="def"><a name="streamer-mix-into">Generic Function</a>
                       <b>streamer-mix-into</b>
 <i>streamer mixer buffer offset length time</i>
 <div class="docbody">
   <p>Generate <i>length</i> samples of audio from <i>streamer</i>.
    The audio should be mixed into the provided <i>buffer</i> (of type
   <a href="#sample-vector"><tt>sample-vector</tt></a>) starting from <i>offset</i>.
   <i>Time</i> indicates the time in samples since the creation of the <i>mixer</i>.</p>
   <p>The provided <a href="#mix-stereo-samples"><tt>mix-stereo-samples</tt></a> function
   or <a href="#stereo-mixf"><tt>stereo-mixf</tt></a> macro can be used for mixing samples.</p>
   <p>When a <i>streamer</i> has completed playback, it can call
   <a href="#mixer-remove-streamer"><tt>mixer-remove-streamer</tt></a>
   after generating its last batch of audio to remove itself from the <i>mixer</i>.</p>
 </div>
</div>

<div class="def"><a name="streamer-write-into">Generic Function</a>
                       <b>streamer-write-into</b>
 <i>streamer mixer buffer offset length time</i>
 <div class="docbody">
   <p>Generate <i>length</i> samples of audio from <i>streamer</i>.
   The contents of <i>buffer</i> (of type <a href="#sample-vector"><tt>sample-vector</tt></a>)
   may be invalid and must be overwritten (not mixed into) starting from <i>offset</i>.
   This method exists as an optimization for the case of the first or only playing streamer,
   to avoid redundant zero-filling of the <i>buffer</i> and unnecessary mixing. The default
   method fills the buffer with zeros then calls <a href="#streamer-mix-into"><tt>streamer-mix-into</tt></a>,
   so implementing a more specific method for this is optional.
   <i>Time</i> indicates the time in samples since the creation of the <i>mixer</i></p>
   <p>When a <i>streamer</i> has completed playback, it can call
   <a href="#mixer-remove-streamer"><tt>mixer-remove-streamer</tt></a>
   after generating its last batch of audio to remove itself from the <i>mixer</i>.</p>
 </div>
</div>


<div class="def"><a name="streamer-cleanup">Generic Function</a>
                       <b>streamer-cleanup</b>
 <i>streamer mixer</i>
 <div class="docbody">
   <p>Notification that <i>streamer</i> has been removed from the <i>mixer</i>, and its streamer
   functions will not be called again. This allows the <i>streamer</i> to release resources
   no longer needed, such as open file handles or foreign memory.</p>
 </div>
</div>


<h4><a name="mix_PausingProtocol"></a>Pausing Protocol</h4>

<p>Streamers are inherently pauseable, achieved by the mixer electing not to call on them to
   generate audio while they are paused (the mixer tracks the paused/playing state itself).
   Therefore, most streamers will have no reason to define more specific methods on these
   functions. A counterexample might be a streamer streaming audio over the network, which
   may want to adjust its buffering behavior when the stream is paused and unpaused.
</p>

<div class="def"><a name="streamer-pause">Generic Function</a>
                       <b>streamer-pause</b>
 <i>streamer mixer</i>
 <div class="docbody">
  <p>Pause playback of the <i>streamer</i> through the <i>mixer</i>. If <i>streamer</i> is already paused, it remains paused.</p>
 </div>
</div>


<div class="def"><a name="streamer-unpause">Generic Function</a>
                       <b>streamer-unpause</b>
 <i>streamer mixer</i>
 <div class="docbody">
  <p>Unpause playback of the <i>streamer</i> through the <i>mixer</i>. If <i>streamer</i> is already playing, it continues to play.</p>
 </div>
</div>


<div class="def"><a name="streamer-paused-p">Generic Function</a>
                       <b>streamer-paused-p</b>
 <i>streamer mixer</i> &rArr;
 <i>boolean</i>
 <div class="docbody">
 <p>Returns true if playback of the <i>streamer</i> through the <i>mixer</i> is currently paused.</p>
 </div>
</div>


<h4><a name="mix_SeekableProtocol"></a>Seekable Protocol</h4>

<p>Some streamers may have the ability to seek to an offset during
playback. These streamers must implement the Seekable protocol,
comprised of the functions below. Users can call these functions to
control and query stream position and length.
</p>

<div class="def"><a name="streamer-seekable-p">Generic Function</a>
                       <b>streamer-seekable-p</b>
 <i>streamer mixer</i> &rArr;
 <i>boolean</i>
 <div class="docbody">
   <p>Returns true is the <i>streamer</i> is seekable. Attempting to
   seek or query the stream length or position may signal an error
   unless this returns true.</p>
 </div>
</div>

<div class="def"><a name="streamer-length">Generic Function</a>
                       <b>streamer-length</b>
 <i>streamer mixer</i> &rArr;
 <i>length-or-nil</i>
 <div class="docbody">
  <p>Returns the length, in samples, of the <i>streamer</i>. If this
  can not be determined, returns nil.</p>
 </div>
</div>

<div class="def"><a name="streamer-seek">Generic Function</a>
                       <b>streamer-seek</b>
 <i>streamer mixer position <tt>&amp;key &amp;allow-other-keys</tt></i>
 <div class="docbody">
   <p>Seek to a <i>position</i>, measured in samples,
   on <i>streamer</i>. Streamers are permitted to seek approximately
   (for instance, rounding to the nearest frame of compressed
   data). Specific streamer types may take additional arguments.</p>
   <p><b>Issue:</b> Should this return a boolean indicated success/failure?
   It's feasible that on compressed or network streams, it might not
   always be possible to seek at all, or the circumstances in which it
   may fail may be subtle. On the other hand, these streams could always
   roll their own protocol using the condition system.</p>
 </div>
</div>

<div class="def"><a name="streamer-position">Generic Function</a>
                       <b>streamer-position</b>
 <i>stream mixer</i> &rArr;
 <i>position</i>
 <div class="docbody">
 <p>Returns the <i>position</i>, measured in samples, of playback within the <i>streamer</i>.</p>
 </div>
</div>


<h3><a name="mix_SampleManipulation"></a>Sample Manipulation</h3>

<p> For simplicity, Mixalot deals uniformly in 16-bit stereo audio,
but the sampling rate may vary. The following type definitions relate
to samples and audio buffers:</p>

<div class="def"><a name="mono-sample">Type</a>
                       <b>mono-sample</b>
 <div class="docbody">
<pre>(deftype mono-sample ()
  '(or (signed-byte 16)
       (unsigned-byte 16)))</pre>
 <p>A mono sample is typically represented as a <tt>(signed-byte
 16)</tt>. Occasionally, it is convenient to use an unsigned
 representation instead.
 </div>
</div>

<div class="def"><a name='stereo-sample'>Type</a>
                       <b>stereo-sample</b>
 <div class="docbody">
   <pre>(deftype stereo-sample () '(unsigned-byte 32))</pre>
   <p>This is the native representation of audio in Mixalot. Two
   16-bit samples are combined into a single word, with the left
   channel stored in the low word and the right channel stored in the
   high word.</p>
 </div>
</div>

<div class="def"><a name='sample-vector'>Type</a>
                       <b>sample-vector</b>
 <div class="docbody">
   <pre>(deftype sample-vector () '(simple-array stereo-sample 1))</pre>
   <p>The <tt>sample-vector</tt> type denotes specialized one-dimensional simple-arrays of stereo samples.</p>
 </div>
</div>


<p>Various functions are available for manipulating samples. All of
the following functions are declared inline, with appropriately
declared types, and compiled to reasonably efficient code at the time
of this writing (using SBCL 1.0.28.27/x86_64).</p>


<div class="def"><a name="stereo-sample">Function</a>
                       <b>stereo-sample</b>
 <i>left right</i> &rArr; <i>sample</i>
 <div class="docbody">
   <p>Construct a <a href="#stereo-sample"><tt>stereo-sample</tt></a>
     from separate <i>left</i> and <i>right</i> components, each
     a <a href="#mono-sample"><tt>mono-sample</tt></a>.
 </div>
</div>

<div class="def"><a name="mono->stereo">Function</a>
                       <b>mono->stereo</b>
 <i>mono-sample</i> &rArr; <i>stereo-sample</i>
 <div class="docbody">
   <p>Expand a <a href="#mono-sample"><tt>mono-sample</tt></a> to
   a <a href="#stereo-sample"><tt>stereo-sample</tt></a> by
   duplicating it on the left and right channel.
   </p>
 </div>
</div>

<div class="def"><a name="stereo-left">Function</a>
                       <b>stereo-left</b>
 <i>stereo-sample</i> &rArr; <i>left</i>
 <div class="docbody">
   <p>Returns the <i>left</i> channel component of a <a href="#stereo-sample"><tt>stereo-sample</tt></a>.</p>
 </div>
</div>

<div class="def"><a name="stereo-right">Function</a>
                       <b>stereo-right</b>
 <i>stereo-sample</i> &rArr; <i>right</i>
 <div class="docbody">
   <p>Returns the <i>right</i> channel component of a <a href="#stereo-sample"><tt>stereo-sample</tt></a>.</p>
 </div>
</div>

<div class="def"><a name="split-sample">Function</a>
                       <b>split-sample</b>
 <i>stereo-sample</i> &rArr; <i>left right</i>
 <div class="docbody">
   <p>Returns two values, the <i>left</i> and <i>right</i> components
   of a <a href="#stereo-sample"><tt>stereo-sample</tt></a>.</p>
 </div>
</div>

<div class="def"><a name="clamp-sample">Function</a>
                       <b>clamp-sample</b>
 <i>integer</i> &rArr; <i>mono-sample</i>
 <div class="docbody">
   <p>Clamp an <i>integer</i> to the range -32,768...32,767.</p>
 </div>
</div>

<div class="def"><a name="clamp-sample+">Function</a>
                       <b>clamp-sample+</b>
 <i>x y</i> &rArr; <i>sum</i>
 <div class="docbody">
   <p>Compute the <i>sum</i> of integers <i>x</i> and <i>y</i>, clamped to the range -32,768...32,767.</p>
 </div>
</div>

<div class="def"><a name="add-stereo-samples">Function</a>
                       <b>add-stereo-samples</b>
 <i>x y</i> &rArr; <i>unclamped-sum</i>
 <div class="docbody">
   <p>Returns the pairwise sum of the <a href="#stereo-sample"><tt>stereo-samples</tt></a>
   <i>x</i> and <i>y</i>, without clipping. The sums of the individual channels may wrap,
   but will not overflow into the other channel.</p>
 </div>
</div>

<div class="def"><a name="mix-stereo-samples">Function</a>
                       <b>mix-stereo-samples</b>
 <i>x y</i> &rArr; <i>clamped-sum</i>
 <div class="docbody">
   <p>Returns the pairwise sum of the <a href="#stereo-sample"><tt>stereo-samples</tt></a>
   <i>x</i> and <i>y</i>, clamped to -32,768...32,767.</p>
 </div>
</div>

<div class="def"><a name="stereo-incf">Macro</a>
                       <b>stereo-incf</b>
 <i>place sample</i> &rArr; <i>sum</i>
 <div class="docbody">
   <p>Increment the contents of <i>place</i> (a <a href="#stereo-sample"><tt>stereo-sample</tt></a>)
   by <i>sample</i> as if by <a href="#add-stereo-samples"><tt>add-stereo-samples</tt></a>.
   </p>
 </div>
</div>

<div class="def"><a name="stereo-mixf">Macro</a>
                       <b>stereo-mixf</b>
 <i>place sample</i> &rArr; <i>sum</i>
 <div class="docbody">
   <p>Increment the contents of <i>place</i> (a <a href="#stereo-sample"><tt>stereo-sample</tt></a>)
   by <i>sample</i> as if by <a href="#mix-stereo-samples"><tt>mix-stereo-samples</tt></a>.
   </p>
 </div>
</div>


<!--  ----------------------------------------------------------------- -->
<h2><a name="mpg123-ffi"></a>System: mpg123-ffi</h2>

<p>The <tt>mpg123-ffi</tt> system presents a thin wrapper around
libmpg123 and should, given the source code, be self explanatory in
combination with the original <a href="http://www.mpg123.de/api/">libmpg123
documentation</a>. It provides bindings to most of the API, excluding
the advanced parameters API and a few functions dealing with
feeding MPEG frames directly into the decoder (and patches for these
are welcome).</p>

<!-- I could write real docs for the FFI definitions, but it would
most be a mechanical translation of CFFI definitions and comments to
pretty HTML. -->

<p>It also manages library initialization and provides helper
functions for retrieving ID3 tags and decoding MP3 files. The ID3
decoding is intended to be robust in the face of badly formed or
encoded input common in MP3 files, and failure to do so should be
reported as a bug.
</p>

<p>The functions are exported from the <tt>mpg123</tt> package and
comprise a thin wrapper in the sense that most of the C functions are
exported directly with no extra lisp wrapper. A few exceptions
involving out parameters and other awkward idioms are wrapped to use
multiple return values instead; only these are documented explicitly
below. For all other functions, see <tt>mpg123.lisp</tt>.
</p>


<div class="def"><a name="ensure-library-initialized">Function</a>
                       <b>ensure-library-initialized</b>
 <div class="docbody">
   <p>Ensures that the libmpg123 has been initialized.</p>
 </div>
</div>

<div class="def"><a name="mpg123-error">Condition</a>
                       <b>mpg123-error</b>
 <div class="docbody">
   <p>An error from the mpg123 library.</p>
 </div>
</div>

<div class="def"><a name="mpg123-handle-error">Condition</a>
                       <b>mpg123-handle-error</b>
 (inherits from <a href="#mpg123-error"><tt>mpg123-error</tt></a>)
 <div class="docbody">
   <p>An error from the mpg123 library in the context of a handle.</p>
 </div>
</div>

<div class="def"><a name="check-mpg123-plain-error">Function</a>
                       <b>check-mpg123-plain-error</b>
 <i>circumstance code</i>
 <div class="docbody">
   <p>Examines the <i>code</i> returned by a call to libmpg123 (excluding
   those functions which act on handles). If it indicates an error, it
   translates the error to a descriptive string and signals an error of
   type <a href="#mpg123-error"><tt>mpg123-error</tt></a>. <i>Circumstance</i>
   is a string, included in the error report, intended to indicate which
   library call produced the error or what the programmer was attempting to do.
   </p>
 </div>
</div>

<div class="def"><a name="check-mh-error">Function</a>
                       <b>check-mh-error</b>
 <i>circumstance handle value</i>
 <div class="docbody">
   <p>Examines the <i>value</i> returned by a call (in the context of the mpg123_handle pointer <i>handle</i>)
   to libmpg123. If it indicates an error, it translates the error to a descriptive string and signals an error of
   type <a href="#mpg123-handle-error"><tt>mpg123-handle-error</tt></a>. <i>Circumstance</i>
   is a string, included in the error report, intended to indicate which
   library call produced the error or what the programmer was attempting to do.
   If no error occurred, <i>value</i> is returned.
   </p>
 </div>
</div>


<div class="def"><a name="mpg123-decoders">Function</a>
                       <b>mpg123-decoders</b>
 &rArr; <i>decoders</i>
 <div class="docbody">
   <p>Returns a list of generally available <i>decoders</i>.</p>
 </div>
</div>

<div class="def"><a name="mpg123-supported-decoders">Function</a>
                       <b>mpg123-supported-decoders</b>
 &rArr; <i>decoders</i>
 <div class="docbody">
   <p>Returns a list of <i>decoders</i> supported by the CPU.</p>
 </div>
</div>

<div class="def"><a name="mpg123-getformat">Function</a>
                       <b>mpg123-getformat</b>
 <i>handle</i> &rArr; <i>rate channels encoding</i>
 <div class="docbody">
   <p>Given a <i>handle</i> with an opened file, returns three
   values indicating the current format: <i>rate</i> (in
   Hertz), <i>channels</i> (1 or 2), and <i>encoding</i> (an integer, one
   of <tt>MPG123_ENC_</tt>... constants).
   </p>
 </div>
</div>

<h3>Helpers</h3>

<div class="def"><a name="get-tags-from-handle">Function</a>
                       <b>get-tags-from-handle</b>
 <i>handle</i> &rArr; <i>plist</i>
 <div class="docbody">
   <p>Examines ID3v1 and ID3v2 tags from an mpg123 <i>handle</i>,
   returning a <i>plist</i> containing a subset of the following keys:</p>
     <ul>
       <li><tt>:title</tt> </li>
       <li><tt>:artist</tt> </li>
       <li><tt>:album</tt> </li>
       <li><tt>:year</tt> </li>
       <li><tt>:comment</tt> </li>
       <li><tt>:genre</tt> </li>
       <li><tt>:track</tt> </li>
     </ul>
     <p>For all keys except <tt>:track</tt>, the property value will
     be a string. If <tt>:track</tt> is present, it will be an
     integer.</p>
     <p>Prefers taking values from ID3v2 tags, but falls back to the
     ID3v1 tag when necessary.  Some heuristics are applied to correct
     or reject obviously incorrect property values. Specifically,
     various forms of year are canonicalized to a four-digit form if a
     reasonable guess can be made, and track numbers of zero are
     removed from the <i>plist</i>.</p>
     <p><b>Issue:</b> Currently only extracts track numbers from the
     ID3v2 <tt>TRCK</tt> field, but should definitely fall back to the
     ID3v1.1 track number field if this is not present.</p>
 </div>
</div>


<div class="def"><a name="get-tags-from-file">Function</a>
                       <b>get-tags-from-file</b>
 <i>filename <tt>&amp;key</tt> verbose (character-encoding :iso-8859-1)</i> &rArr; <i>plist</i>
 <div class="docbody">
   <p>Open an MP3 file, examine its tags
      using <a href="#get-tags-from-handle">get-tags-from-handle</a>,
      and return the resulting <i>plist</i>. Unless <i>verbose</i> is true,
      messages from the library are suppressed.</p>
   <p>By default, the <i>filename</i> will be encoded as <tt>iso-8859-1</tt>
      <tt>(latin-1)</tt> before being passed to C; to avoid encoding
      problems on non-ASCII filenames, it is recommended you obtain
      the <i>filename</i> string with this in mind. You can change this
      behavior using the <tt>:character-encoding</tt> keyword, which can take any valid
      <a href="http://common-lisp.net/project/babel/">Babel</a> encoding specifier
      (another reasonable choice is <tt>:utf-8b</tt>, but again, this choice
      should be congruent with how the string was obtained from the filesystem).
   </p>
 </div>
</div>

<div class="def"><a name="decode-mp3-file">Function</a>
                       <b>decode-mp3-file</b>
 <i>filename <tt>&amp;key</tt> verbose (character-encoding :iso-8859-1)</i> &rArr; <i>vector rate channels encoding</i>
 <div class="docbody">
   <p>Opens and decodes an MP3 file, returning a <i>vector</i> of
   samples, a <tt>(simple-array (signed-byte 16) 1)</tt>, interleaved, with one array
   element per channel.
   The <tt>:character-encoding</tt> keyword chooses how the <i>filename</i> is encoded as a C string.
   Additionally, the <i>rate</i>, <i>channels</i>, and <i>encoding</i> () of the file are returned (see <a href="#mpg123-getformat">mpg123-getformat</a>).
   Unless <i>verbose</i> is true, messages from the library are suppressed.
   </p>
 </div>
</div>

<!--  ----------------------------------------------------------------- -->
<h2><a name="mixalot-mp3"></a>System: mixalot-mp3</h2>

<p>The <tt>mixalot-mp3</tt> system builds on mpg123-ffi to implement a
seekable streamer class for use with the mixer, allowing incremental
decoding and playback of MP3 files from disk. The following functions
reside in the <tt>mixalot-mp3</tt> package:</p>

<div class="def"><a name="mp3-streamer">Class</a>
                       <b>mp3-streamer</b>
 <div class="docbody">
   <p>A seekable Mixalot streamer for playing MP3 files.</p>
 </div>
</div>

<div class="def"><a name="make-mp3-streamer">Function</a>
                       <b>make-mp3-streamer</b>
 <i>filename <tt>&amp;rest</tt> args <tt>&amp;key</tt> (output-rate 44100) (class 'mp3-streamer) (prescan t) <tt>&amp;allow-other-keys</tt></i>
 <br> &rArr; <i>mp3-streamer</i>
 <div class="docbody">
   <p>Create and return an <i>mp3-streamer</i> which opens and
   incrementally decodes from the given <i>filename</i>.  If the file
   cannot be opened, an error of
   type <a href="#mpg123-handle-error"><tt>mpg123-handle-error</tt></a>
   is signalled.  The output is resampled according
   to <i>output-rate</i>, which for correct playback should match the
   rate of the mixer the stream will be used with.
   </p>

   <p>The <i>class</i> argument allows specifying an alternate class
   to <tt>make-instance</tt>. This class must be a subclass
   of <a href="#mp3-streamer"><tt>mp3-streamer</tt></a>. Remaining <i>args</i>
   and <i>output-rate</i> are passed to <tt>make-instance</tt> as
   initargs.</p>

   <p>In order to ensure that the file length is correct and enable accurate seeking, it is recommended to scan through the MP3 file before beginning playback. This may result in a noticeable delay while the file is scanned.  The <i>prescan</i> argument controls whether this prescanning occurs. By default, prescanning is enabled.</p>

   <p><b>Note:</b> While libmpg123 can perform automatic resampling,
   the resulting audio quality is very poor, and in practice you
   shouldn't do it. ALSA's dmix does a much better job, although
   resampling through dmix has its own issues (namely,
   unpredictable and often unreasonably high CPU usage when more than
   one program uses the device simultaneously).</p>
 </div>
</div>

<div class="def"><a name="mp3-streamer-release-resources">Function</a>
                       <b>mp3-streamer-release-resources</b>
 <i>mp3-streamer</i>
 <div class="docbody">
   <p>Release foreign resources held by the <i>mp3-streamer</i>. In
   normal operation, <a href="#streamer-cleanup"><tt>streamer-cleanup</tt></a>
   calls this automatically when the streamer is removed from its
   mixer. It's only necessary to call this yourself if
   the <i>mp3-streamer</i> has never been added to a mixer, but you
   want to dispose of it.</p>
 </div>
</div>

<div class="def"><a name="mp3-sample-rate">Function</a>
                       <b>mp3-sample-rate</b>
 <i>mp3-streamer</i> &rArr; <i>rate</i>
 <div class="docbody">
   <p>Returns the native sampling <i>rate</i> of the file behind an <i>mp3-streamer</i>. This may be different from the output sampling rate.</p>
 </div>
</div>

<p>Example of creating and playing an MP3 stream:</p>
<pre class='lisp'>
CL-USER&gt; (mixalot:mixer-add-streamer *mixer*
           (mixalot-mp3:make-mp3-streamer "/home/hefner/test.mp3"))
#&lt;MIXALOT-MP3:MP3-STREAMER {10029B9A91}&gt;
8463564800
</pre>

<!--  ----------------------------------------------------------------- -->
<h2><a name="vorbisfile-ffi"></a>System: vorbisfile-ffi</h2>

<p>The <tt>vorbisfile-ffi</tt> system presents a thin wrapper around
libvorbisfile and should, given the source code, be self explanatory in
combination with the original <a
href="http://xiph.org/vorbis/doc/vorbisfile/index.html">libvorbisfile
documentation</a>. It provides bindings to most of the API that is required
to decode Ogg Vorbis audio.</p>

<!-- I could write real docs for the FFI definitions, but it would
most be a mechanical translation of CFFI definitions and comments to
pretty HTML. -->

<p>There are also convenience functions to extract so-called vorbis comments,
but only those that are useful and equivalent to ID3 tags in MP3 files.
</p>

<p>The functions are exported from the <tt>vorbisfile</tt> package and
comprise a thin wrapper. Mostly, the exported functions call the C functions
while immediately doing some error checking. For all other functions, see
<tt>vorbisfile.lisp</tt>. </p>


<div class="def"><a name="vorbis-error">Condition</a>
                       <b>vorbis-error</b>
 <div class="docbody">
   <p>An error from the vorbisfile library.</p>
 </div>
</div>

<div class="def"><a name="vorbis-strerror">Function</a>
                       <b>vorbis-strerror</b>
 <i>code</i> &rArr; <i>string</i>
 <div class="docbody">
   <p>Translate an integer <i>code</i> from the vorbisfile library into a
   somewhat more descriptive <i>string</i>.</p>
 </div>
</div>

<div class="def"><a name="check-vorbis-error">Function</a>
                       <b>check-vorbis-error</b>
 <i>circumstance code</i>
 <div class="docbody">
   <p>Examines the <i>code</i> returned by a call to libvorbisfile. If it
   indicates an error, it translates the error to a descriptive string and
   signals an error of type <a href="#vorbis-error"><tt>vorbis-error</tt></a>.
   <i>Circumstance</i> is a string, included in the error report, intended to
   indicate which library call produced the error or what the programmer was
   attempting to do.</p>
 </div>
</div>

<div class="def"><a name="raise-vorbis-error">Function</a>
                       <b>raise-vorbis-error</b>
 <i>circumstance message</i>
 <div class="docbody">
   <p>Signal an error of type <a
   href="#vorbis-error"><tt>vorbis-error</tt></a>. <i>Circumstance</i> is a
   string, included in the error report, intended to indicate which library
   call produced the error or what the programmer was attempting to do.
   <i>Message</i> is a string, included in the error report, that describes
   why the call failed.</p> </div>
</div>


<div class="def"><a name="vorbis-new">Function</a>
                       <b>vorbis-new</b>
 &rArr; <i>handle</i>
 <div class="docbody">
   <p>Allocates foreign resources for a new <i>handle</i> and returns it. This
   foreign resource must be released by the programmer using <a
   href="#vorbis-delete"><tt>vorbis-delete</tt></a>.</p>
 </div>
</div>

<div class="def"><a name="vorbis-delete">Function</a>
                       <b>vorbis-delete</b>
 <i>handle</i>
 <div class="docbody">
   <p>Release the foreign resource of <i>handle</i> that was allocated earlier
   using <a href="#vorbis-new"><tt>vorbis-new</tt></a>.</p>
 </div>
</div>

<div class="def"><a name="vorbis-open">Function</a>
                       <b>vorbis-open</b>
 <i>filename handle <tt>&key</tt> (character-encoding :iso-8859-1)</i>
 <div class="docbody">
   <p>Open the file with the given <i>filename</i> and attach it to the given
   <i>handle</i>, which must have already been created using <a
   href="#vorbis-new"><tt>vorbis-new</tt></a>. This function calls the C
   function <tt>ov_fopen</tt>. If an error occurs, an error of type <a
   href="#vorbis-error"><tt>vorbis-error</tt></a> is raised.</p>
   <p>By default, the <i>filename</i> will be encoded as <tt>iso-8859-1</tt>
   <tt>(latin-1)</tt> before being passed to C; to avoid encoding problems on
   non-ASCII filenames, it is recommended you obtain the <i>filename</i>
   string with this in mind. You can change this behavior using the
   <tt>:character-encoding</tt> keyword, which can take any valid <a
   href="http://common-lisp.net/project/babel/">Babel</a> encoding specifier
   (another reasonable choice is <tt>:utf-8b</tt>, but again, this choice
   should be congruent with how the string was obtained from the filesystem).
   </p>
 </div>
</div>

<div class="def"><a name="vorbis-close">Function</a>
                       <b>vorbis-close</b>
 <i>handle</i>
 <div class="docbody">
   <p>Open the file with the given <i>filename</i> and attach it to the given
   <i>handle</i>, using the C function <tt>ov_fopen</tt>. If an error occurs,
   an error of type <a href="#vorbis-error"><tt>vorbis-error</tt></a> is
   raised.</p>

 </div>
</div>

<div class="def"><a name="vorbis-seek">Function</a>
                       <b>vorbis-seek</b>
 <i>handle position <tt>&amp;key</tt> (accurate t)</i>
 <div class="docbody">
   <p>In the Vorbis stream given by <i>handle</i>, seek to the given
   <i>position</i> in samples. This uses the C function
   <tt>ov_pcm_seek_lap</tt> when <i>accurate</i> is <tt>t</tt>, and
   <tt>ov_pcm_seek_page_lap</tt> when it is <tt>nil</tt>, which is faster. If
   an error occurs, an error of type <a
   href="#vorbis-error"><tt>vorbis-error</tt></a> is raised.</p>

 </div>
</div>

<div class="def"><a name="vorbis-channels">Function</a>
                       <b>vorbis-channels</b>
 <i>handle <tt>&amp;key</tt> (link -1)</i> &rArr; <i>number-of-channels</i>
 <div class="docbody">
   <p>Returns an integer representing the <i>number-of-channels</i> in the
   Vorbis stream given by <i>handle</i> and logical stream <i>link</i> (-1 for
   the current). If an error occurs, an error of type <a
   href="#vorbis-error"><tt>vorbis-error</tt></a> is raised.</p>

 </div>
</div>

<div class="def"><a name="vorbis-rate">Function</a>
                       <b>vorbis-rate</b>
 <i>handle <tt>&amp;key</tt> (link -1)</i> &rArr; <i>sampling-rate</i>
 <div class="docbody">
   <p>Returns an integer representing the <i>sampling-rate</i> in Hz of the
   Vorbis stream given by <i>handle</i> and logical stream <i>link</i> (-1 for
   the current). If an error occurs, an error of type <a
   href="#vorbis-error"><tt>vorbis-error</tt></a> is raised.</p>

 </div>
</div>

<div class="def"><a name="vorbis-length">Function</a>
                       <b>vorbis-length</b>
 <i>handle <tt>&amp;key</tt> (link -1)</i> &rArr; <i>total-number-of-samples</i>
 <div class="docbody">
   <p>Returns an integer representing the <i>total-number-of-samples</i> in
   the Vorbis stream given by <i>handle</i> and logical stream <i>link</i> (-1
   for the current), by calling the C function <tt>ov_pcm_total</tt>. If an
   error occurs, an error of type <a
   href="#vorbis-error"><tt>vorbis-error</tt></a> is raised.</p>

 </div>
</div>

<div class="def"><a name="vorbis-position">Function</a>
                       <b>vorbis-position</b>
 <i>handle</i> &rArr; <i>sample-position</i>
 <div class="docbody">
   <p>Returns an integer representing the current <i>sample-position</i> in
   the Vorbis stream given by <i>handle</i>, by calling the C function
   <tt>ov_pcm_tell</tt>. If an error occurs, an error of type <a
   href="#vorbis-error"><tt>vorbis-error</tt></a> is raised.</p>

 </div>
</div>

<h3>Helpers</h3>

<div class="def"><a name="get-vorbis-tags-from-handle">Function</a>
                       <b>get-vorbis-tags-from-handle</b>
 <i>handle <tt>&amp;key</tt> (link -1)</i> &rArr; <i>plist</i>
 <div class="docbody">
   <p>Examines the comments from a vorbisfile <i>handle</i> and the logical
   stream <i>link</i> (-1 for the current), and returns a <i>plist</i>
   containing a subset of the following keys:</p>
     <ul>
       <li><tt>:title</tt> </li>
       <li><tt>:artist</tt> </li>
       <li><tt>:album</tt> </li>
       <li><tt>:year</tt> </li>
       <li><tt>:comment</tt> </li>
       <li><tt>:genre</tt> </li>
       <li><tt>:track</tt> </li>
     </ul>
     <p>For all keys except <tt>:track</tt>, the property value will
     be a string. If <tt>:track</tt> is present, it will be an
     integer.</p>
     <p>For the key <tt>:year</tt>, the property value will in fact contain
     the value of the <tt>DATE</tt> field in the vorbis comments. Similarly,
     the property value for the <tt>:track</tt> key will contain the value of
     the <tt>TRACKNUMBER</tt> field in the Vorbis comments. This maps the
     vorbis comments well onto ID3 tags in MP3 files. Some heuristics are
     applied to correct or reject obviously incorrect property values.
     Specifically, track numbers of zero are removed from the
     <i>plist</i>. Additionally, for Vorbis comments it is recommended to use
     multiple values of the <tt>ARTIST</tt> field if necessary. Such
     occurences are collected under one <tt>:artist</tt> key, with the values
     comma-separated, and in the order in which the fields were encountered.
     </p>
     <p><b>Issue:</b> The Vorbis comment field <tt>DATE</tt> can contain a
     full date instead of just a year, in any possible form. In fact, all
     fields are basically free-form. This makes it a bit more difficult to
     cannonicalize the contents of the fields. In the specific case of
     <tt>DATE</tt>, the field values are copied as the property values of the
     <tt>:year</tt> key. As such, the value may contain more information
     than the key name suggests.</p>
 </div>
</div>


<div class="def"><a name="get-vorbis-tags-from-file">Function</a>
                       <b>get-vorbis-tags-from-file</b>
 <i>filename</i> <tt>&amp;key</tt> (link -1) (character-encoding :iso-8859-1) &rArr; <i>plist</i>
 <div class="docbody">
   <p>Open an Ogg Vorbis file, examine the tags for the given logical stream
   <i>link</i> (-1 for the current), using <a
   href="#get-vorbis-tags-from-handle">get-vorbis-tags-from-handle</a>, and
   return the resulting <i>plist</i>.</p>
   <p>By default, the <i>filename</i> will be encoded as <tt>iso-8859-1</tt>
   <tt>(latin-1)</tt> before being passed to C; to avoid encoding problems on
   non-ASCII filenames, it is recommended you obtain the <i>filename</i>
   string with this in mind. You can change this behavior using the
   <tt>:character-encoding</tt> keyword, which can take any valid <a
   href="http://common-lisp.net/project/babel/">Babel</a> encoding specifier
   (another reasonable choice is <tt>:utf-8b</tt>, but again, this choice
   should be congruent with how the string was obtained from the filesystem).
   </p>
 </div>
</div>

<!--  ----------------------------------------------------------------- -->
<h2><a name="mixalot-vorbis"></a>System: mixalot-vorbis</h2>

<p>The <tt>mixalot-vorbis</tt> system builds on vorbisfile-ffi to implement a
seekable streamer class for use with the mixer, allowing incremental decoding
and playback of Ogg Vorbis files from disk. Due to the way that mixalot works
at this moment, only mono and stereo Ogg Vorbis files with a sampling rate of
44.1 kHz can be played back. The following functions reside in the
<tt>mixalot-vorbis</tt> package:</p>

<div class="def"><a name="vorbis-streamer">Class</a>
                       <b>vorbis-streamer</b>
 <div class="docbody">
   <p>A seekable Mixalot streamer for playing Ogg Vorbis files.</p>
 </div>
</div>

<div class="def"><a name="make-vorbis-streamer">Function</a>
                       <b>make-vorbis-streamer</b>
 <i>filename <tt>&amp;rest</tt> args <tt>&amp;key</tt> (output-rate 44100)
 (class 'vorbis-streamer) <tt>&amp;allow-other-keys</tt></i>
 <br> &rArr; <i>vorbis-streamer</i>
 <div class="docbody">
   <p>Create and return an <i>vorbis-streamer</i> which opens and
   incrementally decodes from the given <i>filename</i>.  If the file
   cannot be opened, an error of type <a
   href="#vorbis-error"><tt>vorbis-error</tt></a> is signalled.</p>

   <p>The <i>class</i> argument allows specifying an alternate class to
   <tt>make-instance</tt>. This class must be a subclass of <a
   href="#vorbis-streamer"><tt>vorbis-streamer</tt></a>. Remaining <i>args</i>
   and <i>output-rate</i> are passed to <tt>make-instance</tt> as
   initargs.</p>

   <p><b>Note:</b> If <i>output-rate</i> does not match the sample rate of the
   Ogg Vorbis stream, a warning is raised, but the <i>vorbis-streamer</i> will
   be created anyway. Currently, there is no way to resample the stream on the
   fly.</p>
 </div>
</div>

<div class="def"><a name="vorbis-streamer-release-resources">Function</a>
                       <b>vorbis-streamer-release-resources</b>
 <i>vorbis-streamer</i>
 <div class="docbody">
   <p>Release foreign resources held by the <i>vorbis-streamer</i>. In normal
   operation, <a href="#streamer-cleanup"><tt>streamer-cleanup</tt></a> calls
   this automatically when the streamer is removed from its mixer. It's only
   necessary to call this yourself if the <i>vorbis-streamer</i> has never
   been added to a mixer, but you want to dispose of it.</p>
 </div>
</div>

<div class="def"><a name="vorbis-sample-rate">Function</a>
                       <b>vorbis-sample-rate</b>
 <i>vorbis-streamer</i> &rArr; <i>rate</i>
 <div class="docbody">
   <p>Returns the native sampling <i>rate</i> of the file behind a
   <i>vorbis-streamer</i>. This may be different from the output sampling
   rate.</p>
 </div>
</div>

<p>Example of creating and playing an Ogg Vorbis stream:</p>
<pre class='lisp'>
CL-USER&gt; (mixalot:mixer-add-streamer *mixer*
           (mixalot-vorbis:make-vorbis-streamer "/home/soemraws/test.ogg"))
#&lt;VORBIS-STREAMER {1002D80621}&gt;
290816
</pre>

<!--  ----------------------------------------------------------------- -->
<h2><a name="flac-ffi"></a>System: flac-ffi</h2>

<p>The <tt>flac-ffi</tt> system presents a wrapper around libFLAC. As can be
seen from the original <a
href="http://flac.sourceforge.net/api/index.html">libFLAC documentation</a>,
the API of the library requires the use of callbacks etc., which would only
make the use of the ffi for mixalot's purposes difficult. As such, the
<tt>flac-ffi</tt> system exports only functions that make reading a FLAC file
relatively easy.</p>

<p>The functions that are provided, allow for opening a FLAC file, reading
some of the metadata including vorbis comments, decoding the audio into a
buffer, seeking and safely closing the file.</p>

<div class="def"><a name="flac-error">Condition</a>
                       <b>flac-error</b>
 <div class="docbody">
   <p>An error from the FLAC library.</p>
 </div>
</div>

<div class="def"><a name="flac-strerror">Function</a>
                       <b>flac-strerror</b>
 <i>code</i> &rArr; <i>string</i>
 <div class="docbody">
   <p>Translate an integer <i>code</i> from the FLAC library into a
   somewhat more descriptive <i>string</i>. Specifically, this uses
   <tt>FLAC__StreamDecoderErrorStatusString</tt> from the libFLAC API.</p>
 </div>
</div>

<div class="def"><a name="flac-handle">Class</a>
                       <b>flac-handle</b>
 <div class="docbody">
   <p>A handle to a FLAC file. This contains both the handle to the FLAC
   stream decoder, as well as some client data that is used by the internally
   defined callbacks.</p>
 </div>
</div>

<div class="def"><a name="flac-open">Function</a>
                       <b>flac-open</b>
 <i>filename <tt>&amp;key</tt> (character-encoding :iso-8859-1) (with-metadata
 '(:stream-info :vorbis-comment))</i> &rArr; <i>handle</i>
 <div class="docbody">
   <p>Open the FLAC file <i>filename</i> and return a new <a
   href="#flac-handle">flac-handle</a>.</p>
   <p>By default, the <i>filename</i> will be encoded as <tt>iso-8859-1</tt>
   <tt>(latin-1)</tt> before being passed to C; to avoid encoding problems on
   non-ASCII filenames, it is recommended you obtain the <i>filename</i>
   string with this in mind. You can change this behavior using the
   <tt>:character-encoding</tt> keyword, which can take any valid <a
   href="http://common-lisp.net/project/babel/">Babel</a> encoding specifier
   (another reasonable choice is <tt>:utf-8b</tt>, but again, this choice
   should be congruent with how the string was obtained from the filesystem).
   </p>
   <p>The decoder is also instructed by default that it should process the
   metadata of types <tt>:stream-info</tt> and <tt>:vorbis-comment</tt>. While
   it's perfectly possible to work with a FLAC file and skipping
   <tt>:vorbis-comment</tt> processing, it's strongly recommended to at the
   very least use <tt>:stream-info</tt> since it contains important
   information regarding the stream. See <a
   href="#flac-process-metadata">flac-process-metadata</a>.</p>
   </div>
</div>

<div class="def"><a name="flac-close">Function</a>
                       <b>flac-close</b>
 <i>handle</i>
 <div class="docbody">
   <p>Close the <i>handle</i> and release all foreign resources associated
   with it.</p>
 </div>
</div>

<div class="def"><a name="flac-process-metadata">Function</a>
                       <b>flac-process-metadata</b>
 <i>handle</i> &rArr; <i>metadata-plist</i>
 <div class="docbody">
   <p>For a given <i>handle</i>, process the metadata and return it as
   <i>metadata-plist</i>. It is strongly recommended to make this the first
   operation to perform on a new <a href="#flac-handle">flac-handle</a> that
   was acquired with <a href="#flac-open">flac-open</a>. The returned
   <i>metadata-plist</i> will contain the metadata that was requested in the
   call to <a href="#flac-open">flac-open</a>, as a plist. The possible keys
   in this plist are the only metadata types that are currently recognized and
   processed:</p>
   <ul>
     <li><tt>:stream-info</tt></li>
     <li><tt>:vorbis-comment</tt></li>
   </ul>
   <p>The value for <tt>:stream-info</tt> key is itself another plist, with
   the following keys:</p>
   <ul>
     <li><tt>:sample-rate</tt></li>
     <li><tt>:channels</tt></li>
     <li><tt>:bits-per-sample</tt></li>
     <li><tt>:total-samples</tt></li>
     <li><tt>:minimum-block-size</tt></li>
     <li><tt>:maximum-block-size</tt></li>
   </ul>
   <p>As obvious, this plist contains some important information regarding the
   audio in the stream, such as the number of audio channels and the sample
   rate in Hz. The keys <tt>:minimum-block-size</tt> and
   <tt>:maximum-block-size</tt> indicate the range of the size of a block of
   samples that the decoder decodes in one call of <a
   href="#flac-read">flac-read</a>.</p>
   <p>The value for <tt>:vorbis-comment</tt> key is simply a list of
   strings containing the comments in the metadata.</p>
 </div>
</div>

<div class="def"><a name="flac-read">Function</a>
                       <b>flac-read</b>
 <i>handle c-buffer size</i> &rArr; <i>number-of-samples</i>
 <div class="docbody">
   <p>Decode a block of samples from <i>handle</i> into the <i>c-buffer</i>,
   which has the given <i>size</i>, and return the amount of samples that was
   decoded. The <i>c-buffer</i> must be a C buffer where the element type is
   16 bits wide, and the length of the buffer should be equal to the number of
   channels times the maximum block size (see <a
   href="#flac-process-metadata">flac-process-metadata</a> on how to obtain
   this information before starting the decoding). If the current block that
   is being decoded is larger than the provided buffer length, an error of
   type <a href="#flac-error">flac-error</a> is signalled.</p>
   <p><b>Note:</b> This function should allow to provide a buffer with an
   element type that matches the bits per sample of the audio stream.
   Currently, it simply coerces the sample into a 16-bit sample, which is
   probably fine for most cases.</p>
 </div>
</div>

<div class="def"><a name="flac-tell">Function</a>
                       <b>flac-tell</b>
 <i>handle</i> &rArr; <i>sample-position</i>
 <div class="docbody">
   <p>Returns the current sample position of <i>handle</i>.</p>
 </div>
</div>

<div class="def"><a name="flac-seek">Function</a>
                       <b>flac-seek</b>
 <i>handle position</i> &rArr; <i>boolean</i>
 <div class="docbody">
   <p>Seek to the given sample <i>position</i> in <i>handle</i>, and returns
   whether the seek succeeded.</p>
   <p><b>Note:</b> Upon failure, no error is signalled. If the seek fails, it
   probably means the stream is not seekable.</p>
 </div>
</div>

<div class="def"><a name="flac-eof">Function</a>
                       <b>flac-eof</b>
 <i>handle</i> &rArr; <i>boolean</i>
 <div class="docbody">
   <p>Check if <i>handle</i> is at the end-of-file.</p>
 </div>
</div>

<div class="def"><a name="get-flac-tags-from-handle">Function</a>
                       <b>get-flac-tags-from-handle</b>
 <i>handle</i> &rArr; <i>plist</i>
 <div class="docbody">
   <p>Examines the Vorbis comments from the FLAC <i>handle</i> and returns a
   <i>plist</i> containing a subset of the following keys:</p>
     <ul>
       <li><tt>:title</tt> </li>
       <li><tt>:artist</tt> </li>
       <li><tt>:album</tt> </li>
       <li><tt>:year</tt> </li>
       <li><tt>:comment</tt> </li>
       <li><tt>:genre</tt> </li>
       <li><tt>:track</tt> </li>
     </ul>
     <p>This naturally assumes that <i>handle</i> was returned by <a
     href="#flac-open">flac-open</a> with <tt>:vorbis-comment</tt> in the list
     of elements of the <tt>:with-metadata</tt> keyword argument. Since this
     function calls <a
     href="#flac-process-metadata">flac-process-metadata</a>, the stream is
     reset and afterwards will be at the beginning of the audio stream.</p>
     <p>For all keys except <tt>:track</tt>, the property value will
     be a string. If <tt>:track</tt> is present, it will be an
     integer.</p>
     <p>For the key <tt>:year</tt>, the property value will in fact contain
     the value of the <tt>DATE</tt> field in the vorbis comments. Similarly,
     the property value for the <tt>:track</tt> key will contain the value of
     the <tt>TRACKNUMBER</tt> field in the Vorbis comments. This maps the
     vorbis comments well onto ID3 tags in MP3 files. Some heuristics are
     applied to correct or reject obviously incorrect property values.
     Specifically, track numbers of zero are removed from the
     <i>plist</i>. Additionally, for Vorbis comments it is recommended to use
     multiple values of the <tt>ARTIST</tt> field if necessary. Such
     occurences are collected under one <tt>:artist</tt> key, with the values
     comma-separated, and in the order in which the fields were encountered.
     </p>
     <p><b>Issue:</b> The Vorbis comment field <tt>DATE</tt> can contain a
     full date instead of just a year, in any possible form. In fact, all
     fields are basically free-form. This makes it a bit more difficult to
     cannonicalize the contents of the fields. In the specific case of
     <tt>DATE</tt>, the field values are copied as the property values of the
     <tt>:year</tt> key. As such, the value may contain more information
     than the key name suggests.</p>
 </div>
</div>


<div class="def"><a name="get-flac-tags-from-file">Function</a>
                       <b>get-flac-tags-from-file</b>
 <i>filename <tt>&amp;key</tt> (character-encoding :iso-8859-1)</i> &rArr; <i>plist</i>
 <div class="docbody">
   <p>Open a FLAC file, examine the tags using <a
   href="#get-flac-tags-from-handle">get-flac-tags-from-handle</a>, and return
   the resulting <i>plist</i>.</p>
   <p>By default, the <i>filename</i> will be encoded as <tt>iso-8859-1</tt>
      <tt>(latin-1)</tt> before being passed to C; to avoid encoding
      problems on non-ASCII filenames, it is recommended you obtain the
      <i>filename</i> string with this in mind. You can change this behavior
      using the <tt>:character-encoding</tt> keyword, which can take any valid
      <a href="http://common-lisp.net/project/babel/">Babel</a> encoding
      specifier (another reasonable choice is <tt>:utf-8b</tt>, but again,
      this choice should be congruent with how the string was obtained from
      the filesystem).
   </p>
 </div>
</div>

<!--  ----------------------------------------------------------------- -->
<h2><a name="mixalot-flac"></a>System: mixalot-flac</h2>

<p>The <tt>mixalot-flac</tt> system builds on flac-ffi to implement a
seekable streamer class for use with the mixer, allowing incremental decoding
and playback of FLAC files from disk. Due to the way that mixalot works at
this moment, only 16-bit stereo FLAC files with a sampling rate of 44.1 kHz
can be played back. The following functions reside in the
<tt>mixalot-flac</tt> package:</p>

<div class="def"><a name="flac-streamer">Class</a>
                       <b>flac-streamer</b>
 <div class="docbody">
   <p>A seekable Mixalot streamer for playing FLAC files.</p>
 </div>
</div>

<div class="def"><a name="make-flac-streamer">Function</a>
                       <b>make-flac-streamer</b>
 <i>filename <tt>&amp;rest</tt> args <tt>&amp;key</tt> (output-rate 44100)
 (class 'flac-streamer) <tt>&amp;allow-other-keys</tt></i>
 <br> &rArr; <i>flac-streamer</i>
 <div class="docbody">
   <p>Create and return a <i>flac-streamer</i> which opens and incrementally
   decodes from the given <i>filename</i>.  If the file cannot be opened, an
   error of type <a href="#flac-error"><tt>flac-error</tt></a> is
   signalled.</p>

   <p>The <i>class</i> argument allows specifying an alternate class
   to <tt>make-instance</tt>. This class must be a subclass
   of <a href="#flac-streamer"><tt>flac-streamer</tt></a>. Remaining
   <i>args</i> and <i>output-rate</i> are passed to <tt>make-instance</tt> as
   initargs.</p>

   <p><b>Note:</b> If <i>output-rate</i> does not match the sample rate of the
   FLAC stream, a warning is raised, but the <i>flac-streamer</i> will be
   created anyway. Currently, there is no way to resample the stream on the
   fly.</p>
 </div>
</div>

<div class="def"><a name="flac-streamer-release-resources">Function</a>
                       <b>flac-streamer-release-resources</b>
 <i>flac-streamer</i>
 <div class="docbody">
   <p>Release foreign resources held by the <i>flac-streamer</i>. In normal
   operation, <a href="#streamer-cleanup"><tt>streamer-cleanup</tt></a> calls
   this automatically when the streamer is removed from its mixer. It's only
   necessary to call this yourself if the <i>flac-streamer</i> has never
   been added to a mixer, but you want to dispose of it.</p>
 </div>
</div>

<div class="def"><a name="flac-sample-rate">Function</a>
                       <b>flac-sample-rate</b>
 <i>flac-streamer</i> &rArr; <i>rate</i>
 <div class="docbody">
   <p>Returns the native sampling <i>rate</i> of the file behind a
   <i>flac-streamer</i>. This may be different from the output sampling
   rate.</p>
 </div>
</div>

<p>Example of creating and playing an FLAC stream:</p>
<pre class='lisp'>
CL-USER&gt; (mixalot:mixer-add-streamer *mixer*
           (mixalot-flac:make-flac-streamer "/home/soemraws/test.flac"))
#&lt;FLAC-STREAMER {1004340DB1}&gt;
172032
</pre>

<!--  ----------------------------------------------------------------- -->

<a name='future-work'></a><h2>Future Work</h2>

<p>Various ideas for improvement, which might appear on an as-needed basis:</p>
<ul>
  <li>Interface to libsndfile (work in progress)</li>
  <li>Scheduled start times for streamers</li>
  <li>Refactor mixer into an audio sink and a mixing streamer, making submixes possible through the existing API.</li>
  <li>Protocol for insert effects (between streamer and mixer)</li>
</ul>

<!--  ----------------------------------------------------------------- -->

<a name="License"></a><h2>License</h2>
<p>Permission is hereby granted, free of charge, to any person obtaining
 a copy of this software and associated documentation files (the
 "Software"), to deal in the Software without restriction, including
 without limitation the rights to use, copy, modify, merge, publish,
 distribute, sublicense, and/or sellcopies of the Software, and to
 permit persons to whom the Software is furnished to do so, subject
 to the following conditions:</p>

<p>The above copyright notice and this permission notice shall be
 included in all copies or substantial portions of the Software.</p>

<p>THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,
 EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES
 OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND
 NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT
 HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY,
 WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
 FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR
 OTHER DEALINGS IN THE SOFTWARE.</p>

<hr>
<p>Report bugs to Andy Hefner <i>&lt;ahefner at gmail dot com&gt;</i></p>

</body>
</html>
